{% load staticfiles %}

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>dataRonin</title>
<meta name="keywords" content="" />
<meta name="description" content="" />
<script src="{% static 'visual/js/jquery.js' %}"></script>
<script src="{% static 'visual/js/jquery.flot.js' %}"></script>
<script src="{% static 'visual/js/jquery.flot.axislabels.js' %}"></script>
<script src="{% static 'visual/js/jquery.flot.errorbars.js' %}"></script>
<script src="{% static 'visual/js/jquery.flot.resize.js' %}"></script>
<script>
$(function() {
	/*var timeSeries = [];
	var plusRange = [];
	var minusRange = [];*/
	var datasets = {{ json_time_series|safe }};
	
	// Hard-code color indices (to prevent them from shifting)
	var i = 0;
	$.each(datasets, function(key, val) {
		val.color = i;
		++i;
	});
	
	// Create dataset checkboxes
	var choiceContainer = $("#choices");
	$.each(datasets, function(key, val) {
		choiceContainer.append("<li><input type='checkbox' name='" + key +
			"' checked='checked' id='id" + key + "'></input>" +
			"<label for='id" + key + "'> "
			+ val.label + "</label></li>");
	});
	choiceContainer.find("input").click(plotAccordingToChoices);
	
	{% if show_errors and not log_y  %}
		showErrors = true;
	{% else %}
		showErrors = false;
	{% endif %}
	
	var tsPoints = (showErrors) ? {
		show: true,
		radius: 3,
		errorbars: 'y',
		yerr: {show: true, upperCap: '-', lowerCap: '-', radius: 5}
	} : {
		show: true,
		radius: 3
	};
	
	function plotAccordingToChoices() {
		var data = [];
		choiceContainer.find("input:checked").each(function () {
			var key = $(this).attr("name");
			if (key && datasets[key]) {
				data.push(datasets[key]);
			}
		});
		if (data.length > 0) {
			$.plot("#time_series_placeholder", data, {
				series: {
					lines: {
						show: true
					},
					points: tsPoints
				},
				xaxis: {
					tickDecimals: 0,
					axisLabel: 'Year',
					axisLabelUseCanvas: false
				},
				yaxis: {
					position: "right"
				},
				grid: {
					color: "white",
					borderWidth: 1,
					borderColor: "#777",
					markingsColor: "white",
					hoverable: true,
					clickable: true
				},
				legend: {
					show: false
					/*position: "nw",
					backgroundOpacity: 0.15*/
				}
			});
		}
	}
	
	plotAccordingToChoices();

	/*var timeSeries_points = {
		show: true,
		radius: 5,
		errorbars: 'y',
		yerr: {show: true, upperCap: '-', lowerCap: '-', radius: 5}
	};
	
	{% for year, value, error_bar in time_series %}
		timeSeries.push([{{ year }}, {{ value }}, {{ error_bar }}]);
		plusRange.push({{ value }} + {{ error_bar }});
		minusRange.push({{ value }} - {{ error_bar }});
	{% endfor %}
	
	// Add some space to the top and bottom of the time series plot, and make
	// sure the margins are symmetric
	plusRange.sort();
	minusRange.sort();
	var yMin = (minusRange[0] > 0) ? minusRange[0] / 1.1 : minusRange[0] * 1.1;
	var yMax = (plusRange.slice(-1)[0] > 0) ? plusRange.slice(-1)[0] * 1.1 : 
		plusRange.slice(-1)[0] / 1.1;
	plusDiff = Math.abs(plusRange.slice(-1)[0] - yMax);
	minusDiff = Math.abs(minusRange[0] - yMin);
	if (plusDiff > minusDiff) {
		yMin = minusRange[0] - plusDiff;
	}
	else {
		yMax = plusRange.slice(-1)[0] + minusDiff;
	}
		
	var data = [
		{
			data: timeSeries,
			label: "{{ dataset }}",
			color: "green",
			points: timeSeries_points,
			lines: {show: true}
		}
	]
	
	var plot = $.plot("#time_series_placeholder", data, {
			series: {
				lines: {
					show: true
				},
				points: {
					show: true
				}
			},
			grid: {
				hoverable: true,
				clickable: true
			},
			xaxis: {
				axisLabel: 'Year',
				axisLabelUseCanvas: false
			},
			yaxis: {
				min: yMin,
				max: yMax
			}
		});
	*/	
	function showTooltip(x, y, contents) {
		$("<div id='tooltip'>" + contents + "</div>").css({
			position: "absolute",
			display: "none",
			top: y - 25,
			left: x + 5,
			border: "1px solid #ccc",
			padding: "2px",
			"background-color": "#fff",
			color: "#000",
			opacity: 0.80
		}).appendTo("body").fadeIn(200);
	}

	var previousPoint = null;
	$("#time_series_placeholder").bind("plothover", function (event, pos, item) {		
		if (item) {
			if (previousPoint != item.dataIndex) {
				previousPoint = item.dataIndex;
				$("#tooltip").remove();
				var x = item.datapoint[0].toFixed(2),
				y = item.datapoint[1].toFixed(2);
				{% if log_y %}
					showTooltip(item.pageX, item.pageY,
						"log(" + item.series.label + ") = " + y + " in year " + parseInt(x));
				{% else %}
					showTooltip(item.pageX, item.pageY,
						item.series.label + " = " + y + " in year " + parseInt(x));
				{% endif %}
			}
		} else {
			$("#tooltip").remove();
			previousPoint = null;            
		}
	});

	$("#time_series_placeholder").bind("plotclick", function (event, pos, item) {
		if (item) {
			$("#clickdata").text(" - click point " + item.dataIndex + " in " + item.series.label);
			plot.highlight(item.series, item.datapoint);
		}
	});
	
});

$(function() {
	/*
	var histogram = [];
	
	{% for bin, percent in histogram %}
		histogram.push([{{ bin }}, {{ percent }}]);
	{% endfor %}
	
	var plot = $.plot("#histogram_placeholder", [
			{ data: histogram, label: "{{ dataset }}", color: "green"}
		], {
			bars: {
				show: true,
				barWidth: histogram[1][0] - histogram[0][0]
			},
			grid: {
				hoverable: true,
				clickable: true
			},
			yaxis: {
				axisLabel: '%',
				axisLabelUseCanvas: true
			}
		});
		
	function showTooltip(x, y, contents) {
		$("<div id='tooltip'>" + contents + "</div>").css({
			position: "absolute",
			display: "none",
			top: y - 25,
			left: x + 5,
			border: "1px solid #ccc",
			padding: "2px",
			"background-color": "#fff",
			color: "#000",
			opacity: 0.80
		}).appendTo("body").fadeIn(200);
	}
	
	var previousPoint = null;
	$("#histogram_placeholder").bind("plothover", function (event, pos, item) {		
		if (item) {
			if (previousPoint != item.dataIndex) {
				previousPoint = item.dataIndex;
				$("#tooltip").remove();
				var x = item.datapoint[0].toFixed(2),
				y = item.datapoint[1].toFixed(2);
				showTooltip(item.pageX, item.pageY,
					y + "% chance of " + item.series.label + " = " + x);
			}
		} else {
			$("#tooltip").remove();
			previousPoint = null;            
		}
	});

	$("#histogram_placeholder").bind("plotclick", function (event, pos, item) {
		if (item) {
			$("#clickdata").text(" - click point " + item.dataIndex + " in " + item.series.label);
			plot.highlight(item.series, item.datapoint);
		}
	});*/
	
	var datasets = {{ json_histogram|safe }};
	
	// Hard-code color indices (to prevent them from shifting)
	var i = 0;
	$.each(datasets, function(key, val) {
		val.color = i;
		++i;
	});
	
	// Create dataset checkboxes
	var choiceContainer = $("#choices");
	
	choiceContainer.find("input").click(plotAccordingToChoices);
	
	function plotAccordingToChoices() {
		var data = [];
		choiceContainer.find("input:checked").each(function () {
			var key = $(this).attr("name");
			if (key && datasets[key]) {
				data.push(datasets[key]);
			}
		});
		if (data.length > 0) {
			$.plot("#histogram_placeholder", data, {
				bars: {
					show: true,
					barWidth: 10 //histogram[1][0] - histogram[0][0]
				},
				grid: {
					color: "white",
					borderWidth: 1,
					borderColor: "#777",
					markingsColor: "white",
					hoverable: true,
					clickable: true
				},
				yaxis: {
					axisLabel: '%',
					axisLabelUseCanvas: false
				},
				xaxis: {
					axisLabel: 'Value',
					axisLabelUseCanvas: false
				},
				legend: {
					position: "ne",
					backgroundOpacity: 0.15
				}
			});
		}
	}
	
	plotAccordingToChoices();
	
	function showTooltip(x, y, contents) {
		$("<div id='tooltip'>" + contents + "</div>").css({
			position: "absolute",
			display: "none",
			top: y - 25,
			left: x + 5,
			border: "1px solid #ccc",
			padding: "2px",
			"background-color": "#fff",
			color: "#000",
			opacity: 0.70
		}).appendTo("body").fadeIn(200);
	}

	var previousPoint = null;
	$("#histogram_placeholder").bind("plothover", function (event, pos, item) {		
		if (item) {
			if (previousPoint != item.dataIndex) {
				previousPoint = item.dataIndex;
				$("#tooltip").remove();
				var x = item.datapoint[0].toFixed(2),
				y = item.datapoint[1].toFixed(2);
				showTooltip(item.pageX, item.pageY,
					y + "% chance of " + item.series.label + " = " + x);
			}
		} else {
			$("#tooltip").remove();
			previousPoint = null;            
		}
	});

	$("#histogram_placeholder").bind("plotclick", function (event, pos, item) {
		if (item) {
			$("#clickdata").text(" - click point " + item.dataIndex + " in " + item.series.label);
			plot.highlight(item.series, item.datapoint);
		}
	});
});
</script>
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700|Archivo+Narrow:400,700" />
<link rel="stylesheet" type="text/css" href="{% static 'visual/style.css' %}" />
</head>
<body>
<div class="wrapper">
	<div id="header-wrapper">
		<div id="header" class="container">
			<div id="logo">
				<h1><a href="index.html"><img src="{% static 'visual/images/dataronin_new.png' %}" alt="dataRonin" /></a></h1>
			</div>	
			<div id="menu">
				<ul>
					<li class="has-sub"><a href="#"><span>Vitae</span></a>
						<ul>
							<li><a href="cv.html"><span>CV</span></a></li>
							<li><a href="publications.html"><span>Publications</span></a></li>
						</ul>
					</li>
					<li class="has-sub"><a href="#"><span>Research</span></a>
						<ul>
							<li><a href="topics.html"><span>Topics</span></a></li>
							<li><a href="instrumentation.html"><span>Instrumentation</span></a></li>
							<li><a href="data.html"><span>Data Analysis</span></a></li>
							<li><a href="field.html"><span>Field Experiences</span></a></li>
							<li><a href="soil.html"><span>Soil Laboratory</span></a></li>
						</ul>
					</li>
					<li class="has-sub"><a href="#">Images</a>
						<ul>
							<li><a href="instruments.html">Instruments</a></li>
							<li><a href="fieldsites.html">Field sites</a></li>
							<li><a href="other.html">Other</a></li>
							<li><a href="video.html">Video</a></li>
						</ul>
					</li>
					<li class="has-sub"><a href="#">Links</a>
						<ul>
							<li><a href="http://andrewsforest.oregonstate.edu">H.J. Andrews</a></li>
							<li><a href="http://www.tinybike.com">Tinybike</a></li>
							<li><a href="http://www.science.oregonstate.edu/~lajthak/">Kate Lajtha</a></li>
						</ul>
					</li>
					<li><a href="about.html">About Fox</a></li>					
				</ul>
			</div>
		</div>
	</div>
	<div id="banner-wrapper"></div>
	<div id="plotter_page" class="container">
		<div id="leftbar">
			<form action="/visual/results/" method="post">
			<ul>
				{% csrf_token %}
				<!---<li>
					Dataset:
					<select name="dataset" id="dataset">
						<option value="bio">bio</option>
						<option value="bio_all">bio_all</option>
						<option value="gro">gro</option>
						<option value="anpp">anpp</option>
						<option value="npp_wet">npp_wet</option>
					</select>
				</li>
				<li><input type="checkbox" value="Yes" name="get_summary" id="get_summary" />Get summary statistics</li>--->
				<li><input type="checkbox" value="Yes" name="get_histogram" id="get_histogram" checked="checked" />Get histogram</li>
				<li><input type="checkbox" value="Yes" name="get_time_series" id="get_time_series" checked="checked" />Get time series</li>
				<li><input type="checkbox" value="Yes" name="log_y" id="log_y" checked="checked" />Log-transform time series</li>
				<li><input type="checkbox" value="Yes" name="show_errors" id="show_errors" />Error bars</li>
				<li><input type="submit" value="Fetch" /></li>
			</ul>
			</form>
		</div>
		<div id="choices">
		<p class="boxheader">Show dataset</p>
		</div>
		<div id="plotter">
			<!---{% if get_summary %}
				<p class="announce">Summary statistics</p>
				<ul>
				{% for stat, value in summary %}
					<li>{{ stat }}: {{ value }}</li>
				{% endfor %}
				</ul>
			{% endif %}--->
			{% if get_time_series %}
				<!---<p class="announce">Time series</p>--->
				<div class="flot-container">
					<div id="histogram_placeholder" class="flot-placeholder"></div>
					<div id="time_series_placeholder" class="flot-placeholder"></div>
				</div>
			{% endif %}
		</div>
	</div>
	<div class="push"></div>
</div>
<div id="footer">
	<p>Copyright &copy; 2013 Fox Peterson.  All rights reserved.<br />Design by <a href="http://www.tinybike.com">Tinybike Interactive</a>.  Plots created with <a href="http://www.flotcharts.org/">Flot</a>.</p>
</div>
</body>
</html>