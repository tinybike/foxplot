{% load staticfiles %}

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>dataRonin</title>
<meta name="keywords" content="" />
<meta name="description" content="" />
<script src="{% static 'visual/js/jquery.js' %}"></script>
<script src="{% static 'visual/js/jquery.flot.js' %}"></script>
<script src="{% static 'visual/js/jquery.flot.axislabels.js' %}"></script>
<script src="{% static 'visual/js/jquery.flot.errorbars.js' %}"></script>
<script>
$(function() {
	/*var timeSeries = [];
	var plusRange = [];
	var minusRange = [];*/
	var datasets = {{ json_time_series|safe }};
	var selectSpan = '{{ select_span }}';
	
	// Hard-code color indices (to prevent them from shifting)
	var i = 0;
	$.each(datasets, function(key, val) {
		val.color = i;
		++i;
	});
	
	// Create dataset checkboxes
	var choiceContainer = $("#choices");
	$.each(datasets, function(key, val) {
		choiceContainer.append("<li><input type='checkbox' name='" + key +
			"' checked='checked' id='id" + key + "'></input>" +
			"<label for='id" + key + "'> "
			+ val.label + "</label></li>");
	});
	choiceContainer.find("input").click(plotAccordingToChoices);
	
	{% if show_errors  %}
		showErrors = true;
	{% else %}
		showErrors = false;
	{% endif %}
	
	var tsPoints = (showErrors) ? {
		show: true,
		radius: 3,
		errorbars: 'y',
		yerr: {show: true, lineWidth: 1, upperCap: '-', lowerCap: '-', radius: 5}
	} : {
		show: true,
		radius: 3
	};
	
	/*{% for year, value, error_bar in time_series %}
		timeSeries.push([{{ year }}, {{ value }}, {{ error_bar }}]);
		plusRange.push({{ value }} + {{ error_bar }});
		minusRange.push({{ value }} - {{ error_bar }});
	{% endfor %}
	
	// Add some space to the top and bottom of the time series plot, and make
	// sure the margins are symmetric
	plusRange.sort();
	minusRange.sort();
	var yMin = (minusRange[0] > 0) ? minusRange[0] / 1.1 : minusRange[0] * 1.1;
	var yMax = (plusRange.slice(-1)[0] > 0) ? plusRange.slice(-1)[0] * 1.1 : 
		plusRange.slice(-1)[0] / 1.1;
	plusDiff = Math.abs(plusRange.slice(-1)[0] - yMax);
	minusDiff = Math.abs(minusRange[0] - yMin);
	if (plusDiff > minusDiff) {
		yMin = minusRange[0] - plusDiff;
	}
	else {
		yMax = plusRange.slice(-1)[0] + minusDiff;
	}*/
	
	var xLabel = (selectSpan === 'year') ? 'Year' : 'Month';
	
	{% if log_y %}
		log_y = true
		transformAxis = function(x) {
			return Math.log(x+0.0001);
		}
	{% else %}
		log_y = false
		transformAxis = function(x) {
			return x;
		}
	{% endif %}
	
	function plotAccordingToChoices() {
		var data = [];
		choiceContainer.find("input:checked").each(function () {
			var key = $(this).attr("name");
			if (key && datasets[key]) {
				data.push(datasets[key]);
			}
		});
		if (data.length > 0) {
			$.plot("#time_series_placeholder", data, {
				series: {
					lines: {
						show: true
					},
					points: tsPoints
				},
				xaxis: {
					tickDecimals: 0,
					axisLabel: xLabel,
					axisLabelUseCanvas: false
				},
				yaxis: {
					position: "right",
					transform: transformAxis
				},
				grid: {
					color: "white",
					borderWidth: 1,
					borderColor: "#777",
					markingsColor: "white",
					hoverable: true,
					clickable: true
				},
				legend: {
					show: false
					/*position: "nw",
					backgroundOpacity: 0.15*/
				}
			});
		}
	}
	
	plotAccordingToChoices();

	function showTooltip(x, y, contents) {
		$("<div id='tooltip'>" + contents + "</div>").css({
			position: "absolute",
			display: "none",
			top: y - 25,
			left: x + 5,
			border: "1px solid #ccc",
			padding: "2px",
			"background-color": "#fff",
			color: "#000",
			opacity: 0.80
		}).appendTo("body").fadeIn(200);
	}
	
	var previousPoint = null;
	$("#time_series_placeholder").bind("plothover", function (event, pos, item) {		
		if (item) {
			if (previousPoint != item.dataIndex) {
				previousPoint = item.dataIndex;
				$("#tooltip").remove();
				var x = item.datapoint[0].toFixed(2),
				y = item.datapoint[1].toFixed(2);
				{% if log_y %}
					showTooltip(item.pageX, item.pageY,
						"log(" + item.series.label + ") = " + y + " in year " + parseInt(x));
				{% else %}
					showTooltip(item.pageX, item.pageY,
						item.series.label + " = " + y + " in year " + parseInt(x));
				{% endif %}
			}
		} else {
			$("#tooltip").remove();
			previousPoint = null;            
		}
	});
	
	$("#time_series_placeholder").bind("plotclick", function (event, pos, item) {
		if (item) {
			$("#clickdata").text(" - click point " + item.dataIndex + " in " + item.series.label);
			plot.highlight(item.series, item.datapoint);
		}
	});
	
});

$(function() {	
	var datasets = {{ json_histogram|safe }};
	var binSizes = [];
	{% for field, bin in bin_sizes %}
		fieldName = '{{ field }}';
		binSize = {{ bin }};
		binSizes.push({
			fieldName: binSize
		});
	{% endfor %}
	
	// Hard-code color indices (to prevent them from shifting)
	var i = 0;
	$.each(datasets, function(key, val) {
		val.color = i;
		++i;
	});
	
	// Create dataset checkboxes
	var choiceContainer = $("#choices");
	
	choiceContainer.find("input").click(plotAccordingToChoices);
	
	{% if hist_log_y %}
		log_y = true
		transformYAxis = function(y) {
			return Math.log(y+0.0001);
		}
	{% else %}
		hist_log_y = false
		transformYAxis = function(y) {
			return y;
		}
	{% endif %}
	{% if hist_log_x %}
		log_x = true
		transformXAxis = function(x) {
			return Math.log(x+0.0001);
		}
	{% else %}
		hist_log_x = false
		transformXAxis = function(x) {
			return x;
		}
	{% endif %}

	function plotAccordingToChoices() {
		var data = [];
		choiceContainer.find("input:checked").each(function () {
			var key = $(this).attr("name");
			if (key && datasets[key]) {
				data.push(datasets[key]);
			}
		});
		if (data.length > 0) {
			$.plot("#histogram_placeholder", data, {
				bars: {
					show: true,
					barWidth: 10 //histogram[1][0] - histogram[0][0]
				},
				grid: {
					color: "white",
					borderWidth: 1,
					borderColor: "#777",
					markingsColor: "white",
					hoverable: true,
					clickable: true
				},
				yaxis: {
					transform: transformYAxis,
					axisLabel: '%',
					axisLabelUseCanvas: false
				},
				xaxis: {
					transform: transformXAxis,
					axisLabel: 'Value',
					axisLabelUseCanvas: false
				},
				legend: {
					position: "ne",
					backgroundOpacity: 0.15
				}
			});
		}
	}
	
	plotAccordingToChoices();
	
	function showTooltip(x, y, contents) {
		$("<div id='tooltip'>" + contents + "</div>").css({
			position: "absolute",
			display: "none",
			top: y - 25,
			left: x + 5,
			border: "1px solid #ccc",
			padding: "2px",
			"background-color": "#fff",
			color: "#000",
			opacity: 0.70
		}).appendTo("body").fadeIn(200);
	}

	var previousPoint = null;
	$("#histogram_placeholder").bind("plothover", function (event, pos, item) {		
		if (item) {
			if (previousPoint != item.dataIndex) {
				previousPoint = item.dataIndex;
				$("#tooltip").remove();
				var x = item.datapoint[0].toFixed(2),
				y = item.datapoint[1].toFixed(2);
				showTooltip(item.pageX, item.pageY,
					y + "% chance of " + item.series.label + " = " + x);
			}
		} else {
			$("#tooltip").remove();
			previousPoint = null;            
		}
	});

	$("#histogram_placeholder").bind("plotclick", function (event, pos, item) {
		if (item) {
			$("#clickdata").text(" - click point " + item.dataIndex + " in " + item.series.label);
			plot.highlight(item.series, item.datapoint);
		}
	});
});
</script>
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700|Archivo+Narrow:400,700" />
<link rel="stylesheet" type="text/css" href="{% static 'visual/style.css' %}" />
</head>
<body>
<div class="wrapper">
	<div id="header-wrapper">
		<div id="header" class="container">
			<div id="logo">
				<h1><a href="index.html"><img src="{% static 'visual/images/dataronin_new.png' %}" alt="dataRonin" /></a></h1>
			</div>	
			<div id="menu">
				<ul>
					<li class="has-sub"><a href="#"><span>Vitae</span></a>
						<ul>
							<li><a href="cv.html"><span>CV</span></a></li>
							<li><a href="publications.html"><span>Publications</span></a></li>
						</ul>
					</li>
					<li class="has-sub"><a href="#"><span>Research</span></a>
						<ul>
							<li><a href="topics.html"><span>Topics</span></a></li>
							<li><a href="instrumentation.html"><span>Instrumentation</span></a></li>
							<li><a href="data.html"><span>Data Analysis</span></a></li>
							<li><a href="field.html"><span>Field Experiences</span></a></li>
							<li><a href="soil.html"><span>Soil Laboratory</span></a></li>
						</ul>
					</li>
					<li class="has-sub"><a href="#">Images</a>
						<ul>
							<li><a href="instruments.html">Instruments</a></li>
							<li><a href="fieldsites.html">Field sites</a></li>
							<li><a href="other.html">Other</a></li>
							<li><a href="video.html">Video</a></li>
						</ul>
					</li>
					<li class="has-sub"><a href="#">Links</a>
						<ul>
							<li><a href="http://andrewsforest.oregonstate.edu">H.J. Andrews</a></li>
							<li><a href="http://www.tinybike.com">Tinybike</a></li>
							<li><a href="http://www.science.oregonstate.edu/~lajthak/">Kate Lajtha</a></li>
						</ul>
					</li>
					<li><a href="about.html">About Fox</a></li>					
				</ul>
			</div>
		</div>
	</div>
	<div id="banner-wrapper"></div>
	<div id="plotter_page" class="container">
		<div id="leftbar">
			<div id="fetch_data">
				<p class="boxheader">Time series options</p>
				<form action="/visual/results/" method="post">
				<ul>
					{% csrf_token %}
					<!---<li>
						Dataset:
						<select name="dataset" id="dataset">
							<option value="bio">bio</option>
							<option value="bio_all">bio_all</option>
							<option value="gro">gro</option>
							<option value="anpp">anpp</option>
							<option value="npp_wet">npp_wet</option>
						</select>
					</li>
					<li><input type="checkbox" value="Yes" name="get_summary" id="get_summary" />Get summary statistics</li>
					<li><input type="checkbox" value="Yes" name="get_histogram" id="get_histogram" checked="checked" />Get histogram</li>
					<li><input type="checkbox" value="Yes" name="get_time_series" id="get_time_series" checked="checked" />Get time series</li>--->
					<li>
					Statistic:&nbsp;&nbsp;
					<select name="select_stat" id="select_stat">
						<option value="mean">mean</option>
						<option value="median">median</option>
						<option value="quartile_1">1st quartile</option>
						<option value="quartile_3">3rd quartile</option>
						<option value="max">maximum</option>
						<option value="min">minimum</option>
					</select>
					</li>
					<li>
					Period:&nbsp;&nbsp;
					<select name="select_span" id="select_span">
						<option value="year">year</option>
						<option value="month">month/season</option>
					</select>
					</li>
					<li><input type="checkbox" value="Yes" name="show_errors" id="show_errors" /> Error bars</li>
					<li><input type="checkbox" value="Yes" name="log_y" id="log_y" checked
					="checked" /> Log-transform</li>
					<li><input type="checkbox" value="Yes" name="align_start" id="align_start" /> Align start times</li>
				</ul>
				<p class="boxheader">Histogram options</p>
				<ul>
				<li>Number of bins:&nbsp;&nbsp;<input type="text" size="1" value="25" name="num_bins" id="num_bins" /></li>
				<li>
				Plot type:&nbsp;&nbsp;
				<select name="plot_type" id="plot_type">
					<option value="points">points</option>
					<option value="bars">bars</option>
					<option value="lines">lines</option>
					<option value="pointslines">points + lines</option>
				</select>
				</li>
				<li><input type="checkbox" value="Yes" name="hist_show_errors" id="hist_show_errors" /> Error bars (NYI)</li>
				<li><input type="checkbox" value="Yes" name="hist_log_x" id="hist_log_x" /> Log-transform x-axis</li>
				<li><input type="checkbox" value="Yes" name="hist_log_y" id="hist_log_y" /> Log-transform y-axis</li>
				</ul>
				<div id="data_button">
					<input class="small_button" type="submit" value="Get data" />
				</div>
				</form>
			</div>
			<div id="choices">
				<p class="boxheader">Datasets</p>
			</div>
		</div>
		<div id="plotter">
			<!---{% if get_summary %}
				<p class="announce">Summary statistics</p>
				<ul>
				{% for stat, value in summary %}
					<li>{{ stat }}: {{ value }}</li>
				{% endfor %}
				</ul>
			{% endif %}--->
			<!---<p class="announce">Time series</p>--->
			<div class="flot-container">
				<div id="histogram_placeholder" class="flot-placeholder"></div>
				<div id="time_series_placeholder" class="flot-placeholder"></div>
			</div>
		</div>
	</div>
	<div class="push"></div>
</div>
<div id="footer">
	<p>Copyright &copy; 2013 <a href="mailto:fox.peterson@oregonstate.edu">Fox Peterson</a>.  All rights reserved.<br />Design by <a href="http://www.tinybike.com">Tinybike Interactive</a>.  Plots created with <a href="http://www.flotcharts.org/">Flot</a>.</p>
</div>
</body>
</html>